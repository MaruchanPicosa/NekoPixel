<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.username }} - NekoPixel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Tiny5&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> 
    <link rel="stylesheet" href="{{ url_for('static', filename='perfil.css') }}">
</head>
<body>
    <header>
         <a href="{{ url_for('index') }}" class="logo">NEKOPIXEL</a>
         <div class="search-bar">
             <input type="text" placeholder="Buscar...">
         </div>
         <div class="user-profile" onclick="toggleDropdown()">
             <div class="avatar-circle avatar-color-{{ (session['username']|length % 6) + 1 if 'username' in session else '1' }}">
                 <img src="{{ url_for('serve_profile_pic', username=session.get('username')) }}" 
                      alt="{{ session.get('username', 'Invitado') }}" 
                      onerror="this.style.display='none'; this.parentElement.setAttribute('data-letter', '{{ (session.get('username', 'N')[0])|upper }}');">
             </div>
             <div id="dropdown-content" class="dropdown-content">
                 {% if 'username' in session %}
                     <a href="{{ url_for('perfil') }}"><i class="fas fa-user-circle"></i> Mi Perfil</a>
                     <a href="{{ url_for('configuracion') }}"><i class="fas fa-cog"></i> Configuración</a>
                     <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                 {% else %}
                     <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</a>
                     <a href="{{ url_for('registro') }}"><i class="fas fa-user-plus"></i> Registrarse</a>
                 {% endif %}
             </div>
         </div>
     </header>

    <main class="perfil-page">
        <section class="profile-banner" style="background-image: url('{{ url_for('serve_profile_banner', username=user.username) }}');"> 
             <label for="banner_pic_input" class="change-banner-button" title="Cambiar banner">
                 <i class="fas fa-image"></i> Cambiar Banner
             </label>
             <form action="{{ url_for('update_profile_banner') }}" method="POST" enctype="multipart/form-data" id="bannerPicForm" style="display: none;">
                 <input type="file" name="banner_pic" id="banner_pic_input" accept="image/*,image/webp" onchange="document.getElementById('bannerPicForm').submit();">
             </form>
        </section>

        <div class="profile-content-wrapper">

            <section class="profile-header-card">
                <div class="profile-avatar-container">
                    <label for="profile_pic_input" class="avatar-circle avatar-color-{{ (user.username|length % 6) + 1 }}">
                         <img src="{{ url_for('serve_profile_pic', username=user.username) }}" 
                              alt="Foto de perfil de {{ user.username }}"
                              onerror="this.style.display='none'; this.parentElement.setAttribute('data-letter', '{{ user.username[0]|upper }}');">
                     </label>
                     <label for="profile_pic_input" class="change-pic-button" title="Cambiar foto de perfil">
                         <i class="fas fa-camera"></i>
                     </label>
                     <form action="{{ url_for('update_profile_pic') }}" method="POST" enctype="multipart/form-data" id="profilePicForm" style="display: none;">
                        <input type="file" name="profile_pic" id="profile_pic_input" accept="image/*,image/webp" onchange="document.getElementById('profilePicForm').submit();">
                     </form>
                </div>
                <div class="profile-user-info">
                    <h2>{{ user.username }}</h2>
                    <p class="user-email"><i class="fas fa-envelope"></i> {{ user.email }}</p>
                </div>
                <div class="profile-actions">
                    <a href="{{ url_for('configuracion') }}" class="button button-secondary">
                        <i class="fas fa-user-edit"></i> Editar Perfil
                    </a>
                </div>
            </section>

            <div class="profile-details-grid">
                <section class="profile-card-section profile-stats-card">
                    <h3><i class="fas fa-chart-line" style="color:rgb(61, 153, 78);" ></i> Estadísticas</h3>
                    <ul class="profile-stats-list">
                        <li><strong>Miembro desde:</strong> <span>{{ user.created_at.strftime('%B %Y') if user.created_at else 'N/A' }}</span></li>
                        <li><strong>Publicaciones:</strong> <span>{{ total_posts }}</span></li>
                        <li><strong>Likes Recibidos:</strong> <span>{{ total_likes }}</span></li> 
                        <li><strong>Comentarios Recibidos:</strong> <span>{{ total_comments }}</span></li>
                    </ul>
                </section>

                <section class="profile-card-section communities-section">
                    <h2><i class="fas fa-crown" style="color:darkgoldenrod;"></i> Comunidades Creados</h2>
                    {% if created_communities %}
                        <ul class="communities-list">
                            {% for community in created_communities %}
                                <li>
                                    <a href="{{ url_for('community', community_id=community['_id']) }}">
                                        <div class="community-list-banner avatar-color-{{ (community.name|length % 6) + 1 }}">
                                             <img src="{{ url_for('serve_community_banner', community_id=community['_id']) }}" 
                                                  alt="Banner de {{ community.name }}"
                                                  onerror="this.style.display='none'; this.parentElement.setAttribute('data-letter', '{{ community.name[0]|upper }}');">
                                         </div>
                                        <span>{{ community.name }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="no-communities">No has creado ningúna Comunidad aún.</p>
                    {% endif %}
                </section>
                
                <section class="profile-card-section communities-section">
                     <h2><i class="fas fa-users" style="color: cadetblue;"></i> Comunidades Unidas</h2>
                    {% if joined_communities %}
                         <ul class="communities-list">
                            {% for community in joined_communities %}
                                 <li>
                                     <a href="{{ url_for('community', community_id=community['_id']) }}">
                                         <div class="community-list-banner avatar-color-{{ (community.name|length % 6) + 1 }}">
                                              <img src="{{ url_for('serve_community_banner', community_id=community['_id']) }}" 
                                                   alt="Banner de {{ community.name }}"
                                                   onerror="this.style.display='none'; this.parentElement.setAttribute('data-letter', '{{ community.name[0]|upper }}');">
                                          </div>
                                         <span>{{ community.name }}</span>
                                     </a>
                                 </li>
                             {% endfor %}
                         </ul>
                    {% else %}
                         <p class="no-communities">No estás unido a ningúna comunidad aún.</p>
                    {% endif %}
                </section>
            </div> <section class="delete-account-section">
                 <h3><i class="fas fa-exclamation-triangle"></i> Zona Peligrosa</h3>
                 <p>Eliminar tu cuenta es permanente y borrará todos tus datos asociados.</p>
                 <form action="{{ url_for('delete_account') }}" method="POST" onsubmit="return confirm('¿Estás SEGURO de eliminar tu cuenta permanentemente? Perderás todos tus datos.');">
                     <button type="submit" class="eliminar-cuenta button">Eliminar Mi Cuenta</button>
                 </form>
             </section>

        </div> </main>

    <footer>
        <p>&copy; 2024 NekoPixel. Todos los derechos reservados.</p>
        <a href="{{ url_for('index') }}" class="footer-icon"><i class="fas fa-home"></i></a>
        <a href="{{ url_for('explore') }}" class="footer-icon"><i class="fas fa-compass"></i></a>
        <a href="#" onclick="togglePopup('postPopup')" class="footer-icon"><i class="fas fa-plus-square"></i></a>
        <a href="{{ url_for('notifications') if 'username' in session else url_for('login') }}" class="footer-icon"><i class="fas fa-bell"></i></a>
        <a href="{{ url_for('perfil') if 'username' in session else url_for('login') }}" class="footer-icon active"><i class="fas fa-user"></i></a> 
    </footer>

    <script>
        function toggleDropdown() {
            var dropdownContent = document.getElementById("dropdown-content");
            dropdownContent.style.display = dropdownContent.style.display === "block" ? "none" : "block";
        }
        window.addEventListener('click', function(event) {
            if (!event.target.closest('.user-profile')) { 
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                     dropdowns[i].style.display = "none";
                }
            }
        });
        
        // Función togglePopup básica (si se usan popups en esta página)
        function togglePopup(popupId) {
             var popup = document.getElementById(popupId);
             if (popup) {
                 popup.classList.toggle("active");
                 document.body.style.overflow = popup.classList.contains('active') ? 'hidden' : 'auto';
             }
        }
        function closePopup(popupId) {
             var popup = document.getElementById(popupId);
             if(popup && popup.classList.contains('active')) {
                 popup.classList.remove('active');
                 if (!document.querySelector('.popup.active')) { document.body.style.overflow = 'auto'; }
             }
        }
    </script>
</body>
</html>